#!/usr/bin/env node
//æ‹¼æ¥ASICå­—ç¬¦é›†å­—ç¬¦
const figlet = require('figlet');
const versionStr = figlet.textSync("Shi Xiao Bo");
//æ¸å˜æ–‡å­—
const Printer = require('@darkobits/lolcatjs');
const _version = require("../package.json").version;
const input = `  \n çŸ³æ™“æ³¢è„šæ‰‹æ¶${_version} \n oneHundred.cool \n ${versionStr}`;
const transformed = Printer.fromString(input);
//é¢œè‰²æ–‡å­—ï¼Œæ–°ç‰ˆä¹‹åªæ”¯æŒes module ä¸æ”¯æŒcommonjsæ¨¡å—è§„èŒƒ
const chalk = require('chalk');
//ç”¨æˆ·äº¤äº’
var inquirer = require('inquirer');
//æ‰§è¡Œshellå‘½ä»¤
const shell = require('shelljs');
//è§£æå‘½ä»¤è¡Œ äº¤äº’
const { program } = require('commander');
//åŠ è½½ä¸­çŠ¶æ€
const ora = require("ora");
const download = require('download-git-repo');

program.version(transformed);
program.option('c, create', "ğŸ˜åˆå§‹åŒ–é¡¹ç›®");


const dictionary = {
    create(env) {
        inquirer
            .prompt([
                {
                    type: "text",
                    message: "â‘  è¯·è¾“å…¥å·¥ç¨‹åç§°",
                    name: 'dirname'
                },
                {
                    type: "list",
                    name: 'jskind',
                    mesage: 'â‘¡è¯·é€‰æ‹©è¯­è¨€',
                    choices: ['âŠ™ typescript', 'âŠ™ javascript']
                }
            ])
            .then((answers) => {
                console.log(answers)
                const _pwd = shell.pwd().stdout;
                const projectPath = `${_pwd}/${answers.dirname}`
                shell.rm("-rf", projectPath)
                shell.mkdir(projectPath)
                const spinner = ora("â° downloading template ...")
                spinner.start();

                const template = 'direct:https://github.com/passerByBo/xb-react-webpack5-template.git';
           
                // download('direct:https://gitlab.com/flippidippi/download-git-repo-fixture.git', 'test/tmp', { clone: true }, function (err) {
                //     console.log(err ? 'Error' : 'Success')
                //   })
               
                download(template, projectPath,{ clone: true }, function (err) {
                    spinner.stop();
                    //ä¸‹è½½æˆåŠŸä¹Ÿä¼šæŠ¥é”™
                    if (err) {
                        console.log(chalk.red('ä¸‹è½½å¤±è´¥ğŸ¯'),err)
                    } else {
                        console.log('ä¸‹è½½æˆåŠŸ')
                        //ä¿®æ”¹package.json ä¸‹çš„nameå±æ€§
                        shell.sed("-i", "xb-react-webpack5-template", answers.dirname, projectPath + "/package.json");
                    }
                })


            })
            .catch((error) => {
                if (error.isTtyError) {
                    console.log(chalk.red("é”™è¯¯ ç»“æŸ âŒ"))
                } else {

                }
            });
    }
}
program.usage('[cmd] <options>')
    .arguments('<cmd> [env]')
    .action(function (cmd, env) {
        const handler = dictionary[cmd];
        if (handler) {
            handler(env)
        } else {
            console.log(chalk.blue(cmd), chalk.red("æš‚æœªæ”¯æŒï¼"))
        }
    })

program.parse(process.argv);